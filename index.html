<!DOCTYPE html>
<html>
<head>
    <title>iohook-macos Electron Test (Polling Mode)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        /* Permission Status Panel */
        .permission-panel {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .permission-granted {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            color: #2e7d32;
        }
        .permission-denied {
            background: #ffebee;
            border: 2px solid #f44336;
            color: #c62828;
        }
        .permission-unknown {
            background: #fff3e0;
            border: 2px solid #ff9800;
            color: #ef6c00;
        }
        .permission-status-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        .permission-message {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .permission-details {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .status-panel {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-card {
            flex: 1;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            text-align: center;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .control-group {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #FF9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-permission { background: #9C27B0; color: white; }
        
        input[type="range"] {
            flex: 1;
            margin: 0 10px;
        }
        
        .event-display {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .event-log {
            flex: 2;
            height: 400px;
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 8px;
            overflow-y: auto;
            border: 2px solid #333;
        }
        .event-stats {
            flex: 1;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
        }
        .stat-item {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
        }
        .stat-value {
            font-weight: bold;
            color: #2196F3;
        }
        
        .event-line {
            margin: 2px 0;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .event-keyboard { background: rgba(76, 175, 80, 0.2); }
        .event-mouse { background: rgba(33, 150, 243, 0.2); }
        .event-scroll { background: rgba(255, 152, 0, 0.2); }
        
        .queue-warning {
            color: #ff9800;
            font-weight: bold;
        }
        .queue-danger {
            color: #f44336;
            font-weight: bold;
        }
        
        /* Disabled state for monitoring controls */
        .controls.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ iohook-macos Electron Test</h1>
            <h3>Polling Mode - Safe & Stable Event Detection</h3>
        </div>

        <!-- Permission Status Panel -->
        <div class="permission-panel permission-unknown" id="permission-panel">
            <div class="permission-message">
                <span class="permission-status-icon" id="permission-icon">‚è≥</span>
                <span id="permission-message">Í∂åÌïú ÏÉÅÌÉú ÌôïÏù∏ Ï§ë...</span>
            </div>
            <div class="permission-details" id="permission-details">
                Ï†ëÍ∑ºÏÑ± Í∂åÌïúÏùÑ ÌôïÏù∏ÌïòÍ≥† ÏûàÏäµÎãàÎã§. Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.
            </div>
            <div style="margin-top: 10px;">
                <button id="check-permission-btn" class="btn-permission">Í∂åÌïú ÏÉÅÌÉú Îã§Ïãú ÌôïÏù∏</button>
                <button id="open-settings-btn" class="btn-permission" style="display: none;">ÏãúÏä§ÌÖú ÏÑ§Ï†ï Ïó¥Í∏∞</button>
            </div>
        </div>

        <div class="status-panel">
            <div class="status-card">
                <h4>Monitoring Status</h4>
                <div id="monitoring-status">Stopped</div>
            </div>
            <div class="status-card">
                <h4>Event Queue Size</h4>
                <div id="queue-size">0</div>
            </div>
            <div class="status-card">
                <h4>Polling Rate</h4>
                <div id="polling-rate">16ms (~60fps)</div>
            </div>
            <div class="status-card">
                <h4>Events/sec</h4>
                <div id="events-per-sec">0</div>
            </div>
        </div>

        <div class="controls" id="controls">
            <div class="control-group">
                <button id="start-btn" class="btn-success">Start Monitoring</button>
                <button id="stop-btn" class="btn-danger">Stop Monitoring</button>
                <button id="clear-log" class="btn-warning">Clear Log</button>
                <button id="clear-queue" class="btn-warning">Clear Queue</button>
            </div>
            
            <div class="control-group">
                <label>Polling Rate:</label>
                <input type="range" id="polling-slider" min="1" max="100" value="16">
                <span id="polling-display">16ms</span>
            </div>
            
            <div class="control-group">
                <button id="performance-on" class="btn-primary">Enable Performance Mode</button>
                <button id="performance-off" class="btn-primary">Disable Performance Mode</button>
                <button id="verbose-toggle" class="btn-primary">Toggle Verbose Logging</button>
            </div>
        </div>

        <div class="event-display">
            <div class="event-log" id="event-log">
                <div style="color: #888;">üì° Event log - waiting for events...</div>
            </div>
            
            <div class="event-stats">
                <h4>üìä Real-time Statistics</h4>
                <div class="stat-item">
                    <span>Total Events:</span>
                    <span class="stat-value" id="stat-total">0</span>
                </div>
                <div class="stat-item">
                    <span>Keyboard Events:</span>
                    <span class="stat-value" id="stat-keyboard">0</span>
                </div>
                <div class="stat-item">
                    <span>Mouse Events:</span>
                    <span class="stat-value" id="stat-mouse">0</span>
                </div>
                <div class="stat-item">
                    <span>Scroll Events:</span>
                    <span class="stat-value" id="stat-scroll">0</span>
                </div>
                <div class="stat-item">
                    <span>Queue Max Size:</span>
                    <span class="stat-value" id="stat-queue-max">0</span>
                </div>
                <div class="stat-item">
                    <span>Uptime:</span>
                    <span class="stat-value" id="stat-uptime">0s</span>
                </div>
                <h4 style="margin-top: 20px;">‚å®Ô∏è Modifier Keys</h4>
                <div class="stat-item">
                    <span>‚áß Shift:</span>
                    <span class="stat-value" id="modifier-shift">OFF</span>
                </div>
                <div class="stat-item">
                    <span>‚åÉ Control:</span>
                    <span class="stat-value" id="modifier-control">OFF</span>
                </div>
                <div class="stat-item">
                    <span>‚å• Option:</span>
                    <span class="stat-value" id="modifier-option">OFF</span>
                </div>
                <div class="stat-item">
                    <span>‚åò Command:</span>
                    <span class="stat-value" id="modifier-command">OFF</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        // Permission status tracking
        let hasPermission = false;
        
        // Statistics tracking
        let stats = {
            total: 0,
            keyboard: 0,
            mouse: 0,
            scroll: 0,
            queueMax: 0,
            startTime: null
        };
        
        // Modifier key state tracking
        let currentModifiers = {
            shift: false,
            control: false,
            option: false,
            command: false
        };
        
        let verboseLogging = true;
        
        // UI Elements
        const permissionPanel = document.getElementById('permission-panel');
        const permissionIcon = document.getElementById('permission-icon');
        const permissionMessage = document.getElementById('permission-message');
        const permissionDetails = document.getElementById('permission-details');
        const checkPermissionBtn = document.getElementById('check-permission-btn');
        const openSettingsBtn = document.getElementById('open-settings-btn');
        const controls = document.getElementById('controls');
        
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const clearLogBtn = document.getElementById('clear-log');
        const clearQueueBtn = document.getElementById('clear-queue');
        const eventLog = document.getElementById('event-log');
        const pollingSlider = document.getElementById('polling-slider');
        const pollingDisplay = document.getElementById('polling-display');
        
        // Update permission UI
        function updatePermissionUI(granted) {
            hasPermission = granted;
            
            if (granted) {
                permissionPanel.className = 'permission-panel permission-granted';
                permissionIcon.textContent = '‚úÖ';
                permissionMessage.textContent = 'Ï†ëÍ∑ºÏÑ± Í∂åÌïúÏù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§';
                permissionDetails.textContent = 'Î™®Îì† Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§. Start Monitoring Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ïù¥Î≤§Ìä∏ Í∞êÏßÄÎ•º ÏãúÏûëÌïòÏÑ∏Ïöî.';
                openSettingsBtn.style.display = 'none';
                controls.classList.remove('disabled');
            } else {
                permissionPanel.className = 'permission-panel permission-denied';
                permissionIcon.textContent = '‚ùå';
                permissionMessage.textContent = 'Ï†ëÍ∑ºÏÑ± Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§';
                permissionDetails.textContent = 'ÌÇ§Î≥¥Îìú Î∞è ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏Î•º Í∞êÏßÄÌïòÎ†§Î©¥ macOS Ï†ëÍ∑ºÏÑ± Í∂åÌïúÏùÑ ÏÑ§Ï†ïÌï¥Ïïº Ìï©ÎãàÎã§.';
                openSettingsBtn.style.display = 'inline-block';
                controls.classList.add('disabled');
            }
        }
        
        // Permission event handlers
        checkPermissionBtn.addEventListener('click', () => {
            ipcRenderer.send('check-permissions');
        });
        
        openSettingsBtn.addEventListener('click', () => {
            ipcRenderer.send('open-accessibility-settings');
        });
        
        // Status monitoring
        setInterval(() => {
            ipcRenderer.send('get-queue-size');
            
            if (stats.startTime) {
                const uptime = Math.floor((Date.now() - stats.startTime) / 1000);
                document.getElementById('stat-uptime').textContent = uptime + 's';
                
                const eventsPerSec = Math.round(stats.total / Math.max(uptime, 1));
                document.getElementById('events-per-sec').textContent = eventsPerSec;
            }
        }, 1000);
        
        // Event listeners
        startBtn.addEventListener('click', () => {
            if (!hasPermission) {
                alert('Ï†ëÍ∑ºÏÑ± Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. Î®ºÏ†Ä Í∂åÌïúÏùÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            ipcRenderer.send('start-monitoring');
            stats.startTime = Date.now();
            document.getElementById('monitoring-status').textContent = 'Running';
            document.getElementById('monitoring-status').style.color = '#4CAF50';
        });
        
        stopBtn.addEventListener('click', () => {
            ipcRenderer.send('stop-monitoring');
            stats.startTime = null;
            document.getElementById('monitoring-status').textContent = 'Stopped';
            document.getElementById('monitoring-status').style.color = '#f44336';
        });
        
        clearLogBtn.addEventListener('click', () => {
            eventLog.innerHTML = '<div style="color: #888;">üì° Event log cleared...</div>';
        });
        
        clearQueueBtn.addEventListener('click', () => {
            ipcRenderer.send('clear-queue');
        });
        
        pollingSlider.addEventListener('input', (e) => {
            const value = e.target.value;
            pollingDisplay.textContent = value + 'ms';
            document.getElementById('polling-rate').textContent = value + 'ms';
            ipcRenderer.send('set-polling-rate', parseInt(value));
        });
        
        document.getElementById('performance-on').addEventListener('click', () => {
            ipcRenderer.send('enable-performance-mode');
        });
        
        document.getElementById('performance-off').addEventListener('click', () => {
            ipcRenderer.send('disable-performance-mode');
        });
        
        document.getElementById('verbose-toggle').addEventListener('click', () => {
            verboseLogging = !verboseLogging;
            ipcRenderer.send('set-verbose-logging', verboseLogging);
            document.getElementById('verbose-toggle').textContent = 
                verboseLogging ? 'Disable Verbose Logging' : 'Enable Verbose Logging';
        });
        
        // IPC Event handlers
        ipcRenderer.on('permission-status', (event, granted) => {
            console.log('Permission status received:', granted);
            updatePermissionUI(granted);
        });
        
        ipcRenderer.on('permission-granted', () => {
            console.log('Permission granted - UI will update automatically');
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 15px; border-radius: 8px; z-index: 1000;';
            successMsg.textContent = 'üéâ Í∂åÌïú ÏÑ§Ï†ï ÏôÑÎ£å! Ïï±Ïù¥ Í≥ß Ïû¨ÏãúÏûëÎê©ÎãàÎã§.';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                document.body.removeChild(successMsg);
            }, 3000);
        });
        
        ipcRenderer.on('queue-size', (event, size) => {
            const queueElement = document.getElementById('queue-size');
            queueElement.textContent = size;
            
            // Color coding for queue size
            if (size > 500) {
                queueElement.className = 'queue-danger';
            } else if (size > 100) {
                queueElement.className = 'queue-warning';
            } else {
                queueElement.className = '';
            }
            
            if (size > stats.queueMax) {
                stats.queueMax = size;
                document.getElementById('stat-queue-max').textContent = size;
            }
        });
        
        // CGEventType mapping table for the frontend
        const CGEventTypes = {
            0: "null",
            1: "leftMouseDown",
            2: "leftMouseUp",
            3: "rightMouseDown",
            4: "rightMouseUp",
            5: "mouseMoved",
            6: "leftMouseDragged",
            7: "rightMouseDragged",
            10: "keyDown",
            11: "keyUp",
            12: "flagsChanged",
            22: "scrollWheel",
            23: "tabletPointer",
            24: "tabletProximity",
            25: "otherMouseDown",
            26: "otherMouseUp",
            27: "otherMouseDragged"
        };
        
        // Helper function to format modifiers
        function formatModifiers(modifiers) {
            if (!modifiers) return '';
            
            const activeModifiers = [];
            if (modifiers.shift) activeModifiers.push('‚áßShift');
            if (modifiers.control) activeModifiers.push('‚åÉCtrl');
            if (modifiers.option) activeModifiers.push('‚å•Opt');
            if (modifiers.command) activeModifiers.push('‚åòCmd');
            
            return activeModifiers.length > 0 ? ` [${activeModifiers.join('+')}]` : '';
        }
        
        ipcRenderer.on('event-data', (event, eventData) => {
            console.log('event-data', eventData);
            stats.total++;
            
            // eventData.type is now an int (CGEventType value)
            const eventTypeInt = eventData.type;
            const eventTypeString = CGEventTypes[eventTypeInt] || "unknown";
            
            // Update current modifier state
            if (eventData.modifiers) {
                currentModifiers = { ...eventData.modifiers };
                updateModifierUI();
            }
            
            // Update statistics based on CGEventType int values
            if (eventTypeInt === 10 || eventTypeInt === 11 || eventTypeInt === 12) {  // keyDown, keyUp, flagsChanged
                stats.keyboard++;
            } else if ((eventTypeInt >= 1 && eventTypeInt <= 7) || (eventTypeInt >= 25 && eventTypeInt <= 27)) {  // mouse events
                stats.mouse++;
            } else if (eventTypeInt === 22) {  // scrollWheel
                stats.scroll++;
            }
            
            // Update stats display
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-keyboard').textContent = stats.keyboard;
            document.getElementById('stat-mouse').textContent = stats.mouse;
            document.getElementById('stat-scroll').textContent = stats.scroll;
            
            // Add to event log
            const timestamp = new Date().toLocaleTimeString();
            let eventClass = 'event-scroll';  // default
            if (eventTypeInt === 10 || eventTypeInt === 11 || eventTypeInt === 12) {
                eventClass = 'event-keyboard';
            } else if ((eventTypeInt >= 1 && eventTypeInt <= 7) || (eventTypeInt >= 25 && eventTypeInt <= 27)) {
                eventClass = 'event-mouse';
            }
            
            const eventLine = document.createElement('div');
            eventLine.className = `event-line ${eventClass}`;
            
            let details = `[${timestamp}] ${eventTypeString} (${eventTypeInt})`;
            if (eventData.x !== undefined) details += ` at (${Math.round(eventData.x)}, ${Math.round(eventData.y)})`;
            if (eventData.keyCode) details += ` key:${eventData.keyCode}`;
            
            // Add modifiers information
            const modifiersText = formatModifiers(eventData.modifiers);
            if (modifiersText) details += modifiersText;
            
            if (eventData.processId) details += ` pid:${eventData.processId}`;
            
            eventLine.textContent = details;
            
            eventLog.appendChild(eventLine);
            
            // Auto-scroll and limit log size
            if (eventLog.children.length > 1000) {
                eventLog.removeChild(eventLog.firstChild);
            }
            eventLog.scrollTop = eventLog.scrollHeight;
        });
        
        // Update modifier key UI
        function updateModifierUI() {
            const shiftElem = document.getElementById('modifier-shift');
            const controlElem = document.getElementById('modifier-control');
            const optionElem = document.getElementById('modifier-option');
            const commandElem = document.getElementById('modifier-command');
            
            shiftElem.textContent = currentModifiers.shift ? 'ON' : 'OFF';
            shiftElem.style.color = currentModifiers.shift ? '#4CAF50' : '#999';
            
            controlElem.textContent = currentModifiers.control ? 'ON' : 'OFF';
            controlElem.style.color = currentModifiers.control ? '#4CAF50' : '#999';
            
            optionElem.textContent = currentModifiers.option ? 'ON' : 'OFF';
            optionElem.style.color = currentModifiers.option ? '#4CAF50' : '#999';
            
            commandElem.textContent = currentModifiers.command ? 'ON' : 'OFF';
            commandElem.style.color = currentModifiers.command ? '#4CAF50' : '#999';
        }
        
        console.log('üöÄ Electron renderer ready - Polling mode event monitoring');
    </script>
</body>
</html>
